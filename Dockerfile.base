FROM tiangolo/uvicorn-gunicorn:python3.11

WORKDIR /app
RUN mkdir -p /opt/data
RUN mkdir -p /opt/osm

# Container install hack with poetry and web dependencies
RUN pip install uv fastapi[standard] uvicorn

# LLM stuff
RUN pip install llama-index llama-index-llms-openai llama-index-program-openai llama-index-llms-openrouter

# Dashboard stuff
RUN pip install colorcet panel

# Install requirements first in a separate layer to avoid re-installing them on
# every code changes
COPY pyproject.toml /opt/osm
SHELL ["/bin/bash", "--login", "-c"]
RUN  cd /opt/osm ; \
    pip install  -r <(uv pip compile pyproject.toml )
